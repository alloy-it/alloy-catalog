#
# 00-system-base.yml
# Installs base packages required for nRF54 development with nRF Connect SDK.
#
- name: "Update APT cache"
  action: "run_command"
  command: "apt-get update -y"
  always_run: true

- name: "Install Basic Tools"
  action: "apt_install"
  packages:
    - "git"
    - "git-lfs"
    - "unzip"
    - "build-essential"
    - "cmake"
    - "ninja-build"
    - "sudo"
    - "wget"
    - "curl"
    - "xz-utils"
    - "file"
    - "ca-certificates"
    - "gnupg"

- name: "Install Python and pip"
  action: "apt_install"
  packages:
    - "python3"
    - "python3-pip"
    - "python3-venv"
    - "python3-dev"
    - "python3-setuptools"
    - "python3-wheel"

- name: "Install nRF Connect SDK dependencies"
  action: "apt_install"
  packages:
    - "ccache"
    - "dfu-util"
    - "device-tree-compiler"
    - "libffi-dev"
    - "libssl-dev"
    - "libyaml-dev"
    - "libncurses5-dev"
    - "libncursesw5-dev"
    - "gperf"
    - "openocd"
    - "picocom"
    - "minicom"

- name: "Install USB and serial dependencies"
  action: "apt_install"
  packages:
    - "libusb-1.0-0-dev"
    - "usbutils"
    - "libhidapi-hidraw0"
    - "libhidapi-libusb0"

- name: "Allow passwordless sudo for sudo group"
  action: "run_command"
  command: "echo '%sudo	ALL=(ALL:ALL) NOPASSWD:ALL' >> /etc/sudoers"
  creates: "/etc/sudoers.d/nrf54-dev-sudoers"

- name: "Configure udev rules for Nordic devices"
  action: "write_env_file"
  file: "/etc/udev/rules.d/99-nordic.rules"
  content: |
    # Nordic Semiconductor nRF devices (nRF52, nRF91, nRF54)
    # J-Link
    SUBSYSTEM=="usb", ATTR{idVendor}=="1366", MODE="0666", GROUP="plugdev"
    # nRF DKs
    SUBSYSTEM=="usb", ATTR{idVendor}=="1915", MODE="0666", GROUP="plugdev"
  mode: "USER_RW GROUP_R OTHER_R"

- name: "Reload udev rules"
  action: "run_command"
  command: "udevadm control --reload-rules && udevadm trigger"
  always_run: true
