#
# 10-arm-toolchain.yml
# Installs ARM GNU Embedded Toolchain, Zephyr SDK, and Go from catalog.
#
- name: "Create toolchain directories"
  action: "run_command"
  command: |
    mkdir -p {{.Vars.ARM_TOOLCHAIN_DEST}}
    mkdir -p {{.Vars.ZEPHYR_SDK_DEST}}
  creates: "{{.Vars.ARM_TOOLCHAIN_DEST}}"

# --- ARM GNU Embedded Toolchain (arm-none-eabi) ---
- name: "Install ARM GNU Embedded Toolchain"
  action: "unarchive_from_ref"
  ref: "toolchain.arm-gnu.arm-none-eabi@stable"
  dest: "{{.Vars.ARM_TOOLCHAIN_DEST}}"
  creates: "{{.Vars.ARM_TOOLCHAIN_DEST}}/bin/arm-none-eabi-gcc"
  mode: "USER_RWX GROUP_RX OTHER_RX"
  owner: "root:root"

- name: "Add ARM toolchain to PATH"
  action: "write_env_file"
  file: "/etc/profile.d/10-arm-toolchain.sh"
  content: |
    #!/bin/sh
    export GNUARMEMB_TOOLCHAIN_PATH={{.Vars.ARM_TOOLCHAIN_DEST}}
    export PATH=$PATH:{{.Vars.ARM_TOOLCHAIN_DEST}}/bin
  mode: "USER_RWX GROUP_RX OTHER_RX"

# --- Zephyr SDK ---
- name: "Install Zephyr SDK"
  action: "unarchive_from_ref"
  ref: "sdk.zephyr.zephyr-sdk@stable"
  dest: "{{.Vars.ZEPHYR_SDK_DEST}}"
  creates: "{{.Vars.ZEPHYR_SDK_DEST}}/setup.sh"
  mode: "USER_RWX GROUP_RX OTHER_RX"

- name: "Run Zephyr SDK setup"
  action: "run_command"
  command: |
    cd {{.Vars.ZEPHYR_SDK_DEST}}/zephyr-sdk-0.17.0 && ./setup.sh -t arm-zephyr-eabi -h -c
  creates: "{{.Vars.ZEPHYR_SDK_DEST}}/zephyr-sdk-0.17.0/.setup_complete"

- name: "Add Zephyr SDK to environment"
  action: "write_env_file"
  file: "/etc/profile.d/11-zephyr-sdk.sh"
  content: |
    #!/bin/sh
    export ZEPHYR_SDK_INSTALL_DIR={{.Vars.ZEPHYR_SDK_DEST}}
  mode: "USER_RWX GROUP_RX OTHER_RX"

# --- Go Language ---
- name: "Install Go"
  action: "unarchive_from_ref"
  ref: "sdk.golang.go@stable"
  dest: "/usr/local"
  creates: "/usr/local/go/bin/go"
  mode: "USER_RWX GROUP_RX OTHER_RX"

- name: "Add Go to system PATH"
  action: "write_env_file"
  file: "/etc/profile.d/12-golang.sh"
  content: |
    #!/bin/sh
    export PATH=$PATH:/usr/local/go/bin
    export GOPATH=$HOME/go
    export PATH=$PATH:$GOPATH/bin
  mode: "USER_RWX GROUP_RX OTHER_RX"
