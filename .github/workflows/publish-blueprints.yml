# Publish changed blueprints to Alloy Registry
#
# Triggered when blueprints are modified on the main branch.
# Detects which vendor/board blueprints changed, then runs the full
# alloy-cicd pipeline per blueprint: validate, resolve per manifest target
# (e.g. linux/amd64, linux/arm64), pack per target, and push a multi-arch
# blueprint index so clients can pull by platform.
#
# Directory layout: blueprints/<vendor>/<board>/manifest.yml
# Blueprint path:   api.alloy-it.io/community/<vendor>/<board>:<version>

name: Publish Blueprints

on:
  push:
    branches: [main]
    paths:
      - 'blueprints/**'

permissions:
  contents: read

env:
  REGISTRY: api.alloy-it.io
  PROJECT: community

jobs:
  # ---------------------------------------------------------------------------
  # 1. Detect which vendor/board blueprints were modified
  # ---------------------------------------------------------------------------
  detect-changes:
    name: Detect changed blueprints
    runs-on: ubuntu-latest
    outputs:
      blueprints: ${{ steps.changes.outputs.blueprints }}
      has_changes: ${{ steps.changes.outputs.has_changes }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Find changed blueprints
        id: changes
        run: |
          # Extract unique vendor/board pairs from changed files
          # e.g., blueprints/nordic/nrf91/manifest.yml â†’ nordic/nrf91
          CHANGED=$(git diff --name-only HEAD~1 HEAD -- 'blueprints/' | \
            awk -F'/' 'NF>=4 {print $2"/"$3}' | sort -u || true)

          if [ -z "$CHANGED" ]; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "blueprints=[]" >> "$GITHUB_OUTPUT"
            echo "No blueprint changes detected."
            exit 0
          fi

          # Verify each vendor/board has a manifest.yml
          VALID=()
          for bp in $CHANGED; do
            if [ -f "blueprints/${bp}/manifest.yml" ]; then
              VALID+=("\"${bp}\"")
              echo "  Changed: ${bp}"
            fi
          done

          if [ ${#VALID[@]} -eq 0 ]; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "blueprints=[]" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          JSON="[$(IFS=,; echo "${VALID[*]}")]"
          echo "blueprints=${JSON}" >> "$GITHUB_OUTPUT"
          echo "has_changes=true" >> "$GITHUB_OUTPUT"
          echo "Blueprints to publish: ${JSON}"

  # ---------------------------------------------------------------------------
  # 2. Build alloy-cicd (once, shared across publish jobs)
  # ---------------------------------------------------------------------------
  build-tool:
    name: Build alloy-cicd
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Checkout alloy-cicd
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/alloy-cicd
          token: ${{ secrets.ALLOY_CICD_TOKEN }}
          path: alloy-cicd

      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true
          cache-dependency-path: 'alloy-cicd/go.sum'

      - name: Build
        run: |
          cd alloy-cicd
          CGO_ENABLED=0 go build -o ../alloy-cicd-bin ./cmd/alloy-cicd

      - uses: actions/upload-artifact@v4
        with:
          name: alloy-cicd-bin
          path: alloy-cicd-bin

  # ---------------------------------------------------------------------------
  # 3. Validate, resolve, pack, and push each changed blueprint
  # ---------------------------------------------------------------------------
  publish:
    name: Publish ${{ matrix.blueprint }}
    runs-on: ubuntu-latest
    needs: [detect-changes, build-tool]
    if: needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      fail-fast: false
      matrix:
        blueprint: ${{ fromJson(needs.detect-changes.outputs.blueprints) }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: alloy-cicd-bin

      - name: Make binary executable
        run: chmod +x alloy-cicd-bin

      - name: Read blueprint metadata
        id: meta
        run: |
          MANIFEST="blueprints/${{ matrix.blueprint }}/manifest.yml"
          VERSION=$(grep '^version:' "$MANIFEST" | sed 's/version: *"\{0,1\}\([^"]*\)"\{0,1\}/\1/')
          NAME=$(grep '^name:' "$MANIFEST" | sed 's/name: *"\{0,1\}\([^"]*\)"\{0,1\}/\1/')
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "name=${NAME}" >> "$GITHUB_OUTPUT"
          echo "Blueprint: ${NAME} v${VERSION} (${{ matrix.blueprint }})"

      - name: Run pipeline (multi-arch)
        env:
          ALLOY_REGISTRY_USERNAME: ${{ secrets.ALLOY_REGISTRY_USERNAME }}
          ALLOY_REGISTRY_PASSWORD: ${{ secrets.ALLOY_REGISTRY_PASSWORD }}
        run: |
          VERSION="${{ steps.meta.outputs.version }}"

          # Pipeline: validate, resolve per manifest target (linux/amd64, linux/arm64),
          # pack per target, push multi-arch blueprint index. Uses manifest "targets:" not runner OS/arch.
          ./alloy-cicd-bin pipeline \
            --repo . \
            --blueprint "blueprints/${{ matrix.blueprint }}" \
            --catalog-repo . \
            --registry "${{ env.REGISTRY }}" \
            --repository "${{ env.PROJECT }}/${{ matrix.blueprint }}" \
            --tag "${VERSION}" \
            --log-json

      - name: Summary
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" <<EOF
          ### Published: ${{ matrix.blueprint }}

          | Field | Value |
          |-------|-------|
          | **Name** | ${{ steps.meta.outputs.name }} |
          | **Version** | ${{ steps.meta.outputs.version }} |
          | **Image** | \`${{ env.REGISTRY }}/${{ env.PROJECT }}/${{ matrix.blueprint }}:${{ steps.meta.outputs.version }}\` |
          | **Commit** | \`${{ github.sha }}\` |
          EOF
